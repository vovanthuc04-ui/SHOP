<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£n Ph·∫©m - QHBD Fashion</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="top-bar">
            <div class="container">
                <div class="top-bar-content">
                    <div class="top-left">
                        <span>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n h√†ng tr√™n 2.000.000‚Ç´</span>
                    </div>
                    <div class="top-right">
                        <a href="#"><i class="fas fa-phone"></i> Hotline: 0988419285</a>
                        <a href="#"><i class="fas fa-envelope"></i> thoitrang@qhbdfashion.vn</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <a href="index.html">QHBD</a>
                    </div>
                    <nav class="nav-menu">
                        <ul>
                            <li><a href="index.html">Trang Ch·ªß</a></li>
                            <li><a href="products.html?category=men">Nam</a></li>
                            <li><a href="products.html?category=women">N·ªØ</a></li>
                            <li><a href="products.html?category=accessories">Ph·ª• Ki·ªán</a></li>
                            <li><a href="products.html?category=new">H√†ng M·ªõi</a></li>
                            <li><a href="products.html?category=sale">Sale</a></li>
                        </ul>
                    </nav>

                    <div class="header-actions">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m...">
                            <button id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                        <a href="login.html" class="action-btn" id="userBtn">
                            <i class="fas fa-user"></i>
                            <span id="userName"></span>
                        </a>
                        <a href="cart.html" class="action-btn cart-btn">
                            <i class="fas fa-shopping-bag"></i>
                            <span class="cart-count" id="cartCount">0</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Products Page -->
    <section class="products-page">
        <div class="container">
            <div class="products-header">
                <h1 id="pageTitle">T·∫•t C·∫£ S·∫£n Ph·∫©m</h1>
                <div class="breadcrumb">
                    <a href="index.html">Trang Ch·ªß</a>
                    <span>/</span>
                    <span id="breadcrumbCategory">S·∫£n Ph·∫©m</span>
                </div>
            </div>

            <div class="products-container">
                <!-- Filters Sidebar -->
                <aside class="filters">
                    <div class="filter-group">
                        <h3>Danh M·ª•c</h3>
                        <div class="filter-option">
                            <input type="radio" name="category" value="all" id="cat-all" checked>
                            <label for="cat-all">T·∫•t C·∫£</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="category" value="men" id="cat-men">
                            <label for="cat-men">Th·ªùi Trang Nam</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="category" value="women" id="cat-women">
                            <label for="cat-women">Th·ªùi Trang N·ªØ</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="category" value="accessories" id="cat-acc">
                            <label for="cat-acc">Ph·ª• Ki·ªán</label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Gi√°</h3>
                        <div class="filter-option">
                            <input type="radio" name="price" value="all" id="price-all" checked>
                            <label for="price-all">T·∫•t C·∫£</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="price" value="0-500000" id="price-1">
                            <label for="price-1">D∆∞·ªõi 500k</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="price" value="500000-1000000" id="price-2">
                            <label for="price-2">500k - 1tr</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="price" value="1000000-2000000" id="price-3">
                            <label for="price-3">1tr - 2tr</label>
                        </div>
                        <div class="filter-option">
                            <input type="radio" name="price" value="2000000-99999999" id="price-4">
                            <label for="price-4">Tr√™n 2tr</label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3>Tr·∫°ng Th√°i</h3>
                        <div class="filter-option">
                            <input type="checkbox" id="filter-new" value="new">
                            <label for="filter-new">H√†ng M·ªõi</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="filter-sale" value="sale">
                            <label for="filter-sale">ƒêang Sale</label>
                        </div>
                    </div>

                    <button class="btn-submit" onclick="applyFilters()" style="width: 100%; margin-top: 20px;">
                        √Åp D·ª•ng B·ªô L·ªçc
                    </button>
                </aside>

                <!-- Products Grid -->
                <div class="products-main">
                    <div class="products-toolbar">
                        <div class="products-count">
                            <span id="productsCount">ƒêang t·∫£i...</span>
                        </div>
                        <div class="sort-options">
                            <select id="sortSelect" onchange="applyFilters()">
                                <option value="default">S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh</option>
                                <option value="price-asc">Gi√°: Th·∫•p ƒë·∫øn Cao</option>
                                <option value="price-desc">Gi√°: Cao ƒë·∫øn Th·∫•p</option>
                                <option value="name">T√™n: A-Z</option>
                            </select>
                        </div>
                    </div>

                    <div class="products-grid" id="productsGrid">
                        <p style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px;"></i><br>
                            ƒêang t·∫£i s·∫£n ph·∫©m...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-col">
                    <h3>QHBD Fashion</h3>
                    <p>Th·ªùi trang cao c·∫•p cho ng∆∞·ªùi th√†nh ƒë·∫°t. Ch√∫ng t√¥i mang ƒë·∫øn nh·ªØng s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng nh·∫•t v·ªõi thi·∫øt k·∫ø tinh t·∫ø v√† sang tr·ªçng.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-col">
                    <h4>Th√¥ng Tin</h4>
                    <ul>
                        <li><a href="#">V·ªÅ Ch√∫ng T√¥i</a></li>
                        <li><a href="#">Li√™n H·ªá</a></li>
                        <li><a href="#">Tuy·ªÉn D·ª•ng</a></li>
                        <li><a href="#">Tin T·ª©c</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>H·ªó Tr·ª£</h4>
                    <ul>
                        <li><a href="#">Ch√≠nh S√°ch ƒê·ªïi Tr·∫£</a></li>
                        <li><a href="#">H∆∞·ªõng D·∫´n Mua H√†ng</a></li>
                        <li><a href="#">C√¢u H·ªèi Th∆∞·ªùng G·∫∑p</a></li>
                        <li><a href="#">Ch√≠nh S√°ch B·∫£o M·∫≠t</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>Li√™n H·ªá</h4>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> 55 ƒê∆∞·ªùng Gi·∫£i Ph√≥ng, Ho√†ng Mai, H√† N·ªôi</li>
                        <li><i class="fas fa-phone"></i> 0988419285</li>
                        <li><i class="fas fa-envelope"></i>  thoitrang@qhbdfashion.vn</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 QHBD Fashion. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/app.js"></script>
    <script>
        console.log('üöÄ Products page loaded');

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');
        const searchParam = urlParams.get('search');

        console.log('üìç URL Params:', { category: categoryParam, search: searchParam });

        // Set initial filters from URL
        if (categoryParam) {
            const categoryInput = document.getElementById(`cat-${categoryParam}`);
            if (categoryInput) {
                categoryInput.checked = true;
                console.log('‚úÖ Set category:', categoryParam);
            }
            
            // Update page title
            const titles = {
                'men': 'Th·ªùi Trang Nam',
                'women': 'Th·ªùi Trang N·ªØ',
                'accessories': 'Ph·ª• Ki·ªán',
                'new': 'H√†ng M·ªõi',
                'sale': 'Sale'
            };
            document.getElementById('pageTitle').textContent = titles[categoryParam] || 'T·∫•t C·∫£ S·∫£n Ph·∫©m';
            document.getElementById('breadcrumbCategory').textContent = titles[categoryParam] || 'S·∫£n Ph·∫©m';
        }

        if (searchParam) {
            document.getElementById('searchInput').value = searchParam;
            document.getElementById('pageTitle').textContent = `K·∫øt qu·∫£ t√¨m ki·∫øm: "${searchParam}"`;
        }

        // ‚ö†Ô∏è FIX: ƒê·ªïi th√†nh ASYNC function
        async function applyFilters() {
            console.log('üîç Applying filters...');
            
            try {
                const filters = {};
                
                // Category filter
                const selectedCategory = document.querySelector('input[name="category"]:checked');
                if (selectedCategory && selectedCategory.value !== 'all') {
                    filters.category = selectedCategory.value;
                }
                
                // Price filter
                const selectedPrice = document.querySelector('input[name="price"]:checked');
                if (selectedPrice && selectedPrice.value !== 'all') {
                    const [min, max] = selectedPrice.value.split('-');
                    filters.priceMin = parseInt(min);
                    filters.priceMax = parseInt(max);
                }
                
                // Badge filters
                const badges = [];
                if (document.getElementById('filter-new').checked) badges.push('new');
                if (document.getElementById('filter-sale').checked) badges.push('sale');
                if (badges.length > 0) {
                    filters.badge = badges[0]; // API ch·ªâ h·ªó tr·ª£ 1 badge
                }
                
                // Sort
                const sortValue = document.getElementById('sortSelect').value;
                if (sortValue !== 'default') {
                    filters.sort = sortValue;
                }
                
                // Search
                if (searchParam) {
                    filters.search = searchParam;
                }
                
                console.log('üéØ Filters:', filters);
                
                // ‚úÖ FIX: Th√™m AWAIT v√¨ getProducts l√† async
                const products = await getProducts(filters);
                
                console.log('üì¶ Products received:', products.length);
                console.log('üì∏ First product:', products[0]);
                
                // ‚úÖ Render products v·ªõi ·∫£nh
                renderProducts(products, 'productsGrid');
                
                // Update count
                document.getElementById('productsCount').textContent = `${products.length} s·∫£n ph·∫©m`;
                
                console.log('‚úÖ Products rendered successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                
                const container = document.getElementById('productsGrid');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>C√≥ l·ªói x·∫£y ra!</h3>
                        <p>${error.message || 'Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m'}</p>
                        <button onclick="applyFilters()" class="btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> Th·ª≠ L·∫°i
                        </button>
                    </div>
                `;
                
                document.getElementById('productsCount').textContent = '0 s·∫£n ph·∫©m';
            }
        }

        // Initial load when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded');
            console.log('üîß Checking functions...');
            console.log('  - apiClient:', typeof apiClient);
            console.log('  - getProducts:', typeof getProducts);
            console.log('  - renderProducts:', typeof renderProducts);
            
            // Load products
            applyFilters();
        });

        console.log('‚úÖ Products page script loaded');
    </script>
</body>
</html>